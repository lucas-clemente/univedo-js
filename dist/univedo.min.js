/**
 * univedo v0.1.0 
 * https://github.com/lucas-clemente/univedo-js
 * MIT license, (c) 2013-2014 Univedo
 */
!function(e,t,r){"use strict";var n,s,o,i,c,u,a,h,f,l,p={remote_classes:{}};for(o=[],a={},h=l=0;255>=l;h=++l)o[h]=(h+256).toString(16).substr(1),a[o[h]]=h;f=function(e){var t;return t=new Uint8Array(e),h=0,o[t[h++]]+o[t[h++]]+o[t[h++]]+o[t[h++]]+"-"+o[t[h++]]+o[t[h++]]+"-"+o[t[h++]]+o[t[h++]]+"-"+o[t[h++]]+o[t[h++]]+"-"+o[t[h++]]+o[t[h++]]+o[t[h++]]+o[t[h++]]+o[t[h++]]+o[t[h++]]},s=function(e){var t,r,n,s;for(t=new ArrayBuffer(e.length),r=new Uint8Array(t),h=n=0,s=e.length-1;s>=0?s>=n:n>=s;h=s>=0?++n:--n)r[h]=e.charCodeAt(h);return t},n=function(e){return s(String.fromCharCode.apply(null,e))},i=function(e){var t,r,n,s,o,i,c,u;for(s=0,o=0,c=e.length;c>o;o++)t=e[o],s+=t.byteLength;for(n=new Uint8Array(s),r=0,i=0,u=e.length;u>i;i++)t=e[i],n.set(new Uint8Array(t),r),r+=t.byteLength;return n.buffer},u=function(e){var t,r,n,s;for(r=unescape(encodeURIComponent(e)),t=new Uint8Array(r.length),h=n=0,s=r.length;s>=0?s>n:n>s;h=s>=0?++n:--n)t[h]=r.charCodeAt(h);return t.buffer},c=function(e){var t;return t=String.fromCharCode.apply(null,new Uint8Array(e)),decodeURIComponent(escape(t))};var _,d,g,w;_={UINT:0,NEGINT:1,BYTESTRING:2,TEXTSTRING:3,ARRAY:4,MAP:5,TAG:6,SIMPLE:7},g={DATETIME:0,TIME:1,DECIMAL:4,REMOTEOBJECT:6,UUID:7,RECORD:8},d={FALSE:20,TRUE:21,NULL:22,FLOAT32:26,FLOAT64:27},p.Message=w=function(){function e(e,t){this.recvBuffer=e,this.roCallback=t,this.recvOffset=0,this.sendBuffer=new ArrayBuffer(0)}return e.prototype._getDataView=function(e){var t;return t=new DataView(this.recvBuffer,this.recvOffset,e),this.recvOffset+=e,t},e.prototype._getLen=function(e){var t;switch(t=31&e){case 24:return this._getDataView(1).getUint8(0);case 25:return this._getDataView(2).getUint16(0);case 26:return this._getDataView(4).getUint32(0);case 27:throw Error("int64 not yet supported in javascript!");default:return t}},e.prototype.shift=function(){var e,t,r,n,s,o,i,u,a;switch(o=this._getDataView(1).getUint8(0),r=o>>5){case _.UINT:return this._getLen(o);case _.NEGINT:return-this._getLen(o)-1;case _.SIMPLE:switch(31&o){case d.FALSE:return!1;case d.TRUE:return!0;case d.NULL:return null;case d.FLOAT32:return this._getDataView(4).getFloat32(0);case d.FLOAT64:return this._getDataView(8).getFloat64(0);default:throw Error("invalid simple in cbor protocol")}break;case _.BYTESTRING:return t=this._getLen(o),this.recvBuffer.slice(this.recvOffset,this.recvOffset+=t);case _.TEXTSTRING:return t=this._getLen(o),c(this.recvBuffer.slice(this.recvOffset,this.recvOffset+=t));case _.ARRAY:for(t=this._getLen(o),a=[],e=i=0;t>=0?t>i:i>t;e=t>=0?++i:--i)a.push(this.shift());return a;case _.MAP:for(t=this._getLen(o),n={},e=u=0;t>=0?t>u:u>t;e=t>=0?++u:--u)n[this.shift()]=this.shift();return n;case _.TAG:switch(s=this._getLen(o)){case g.DATETIME:return new Date(this.shift());case g.TIME:return new Date(this.shift());case g.UUID:return f(this.shift());case g.RECORD:return this.shift();case g.REMOTEOBJECT:return this.roCallback(this.shift());default:throw Error("invalid tag in cbor protocol")}break;default:throw Error("invalid major in cbor protocol")}},e.prototype.send=function(e){return this.sendBuffer=i([this.sendBuffer,this._sendImpl(e)])},e.prototype._sendSimple=function(e){return n([_.SIMPLE<<5|e])},e.prototype._sendTag=function(e){return n([_.TAG<<5|e])},e.prototype._sendLen=function(e,t){var r;switch(r=e<<5,!1){case!(23>=t):return n([r|t]);case!(256>t):return n([24|r,t]);case!(65536>t):return n([25|r,t>>8,255&t]);case!(4294967296>t):return n([26|r,t>>24,t>>16,t>>8,255&t]);default:throw Error("_sendLen() called with non-uint")}},e.prototype._sendImpl=function(e){var t,r,n,s,o,c,a,h,f,l;switch(!1){case"undefined"!=typeof e:throw Error("cannot send undefined");case null!==e:return this._sendSimple(d.NULL);case e!==!0:return this._sendSimple(d.TRUE);case e!==!1:return this._sendSimple(d.FALSE);case"number"!=typeof e:switch(!1){case!(e>=0&&4294967296>e&&e%1===0):return this._sendLen(_.UINT,e);case!(0>e&&e>=-4294967296&&e%1===0):return this._sendLen(_.NEGINT,-e-1);default:return t=new ArrayBuffer(8),new DataView(t).setFloat64(0,e),i([this._sendSimple(d.FLOAT64),t])}break;case"string"!=typeof e:return o=u(e),i([this._sendLen(_.TEXTSTRING,o.byteLength),o]);case"ArrayBuffer"!==e.constructor.name:return i([this._sendLen(_.BYTESTRING,e.byteLength),e]);case"Array"!==e.constructor.name:for(r=[this._sendLen(_.ARRAY,e.length)],a=0,f=e.length;f>a;a++)c=e[a],r.push(this._sendImpl(c));return i(r);case"Object"!==e.constructor.name:for(s=Object.keys(e),r=[this._sendLen(_.MAP,s.length)],h=0,l=s.length;l>h;h++)n=s[h],r.push(this._sendImpl(n)),r.push(this._sendImpl(e[n]));return i(r);case"Date"!==e.constructor.name:return i([this._sendTag(g.DATETIME),this._sendImpl(e.toISOString())]);default:throw Error("unsupported object in cbor protocol")}},e}();var y,m;y={CALL:1,ANSWER:2,NOTIFY:3,DELETE:4},p.RemoteObject=m=function(){function e(e,t,r){this.session=e,this.id=t,null==r&&(r=[]),this.call_id=0,this.calls=[],this.notification_listeners=[],this.session._remote_objects[this.id]=this,this._addROMs(r)}return e.prototype._callRom=function(e,t){return new r(function(r){return function(n,s){return r.session._sendMessage([r.id,y.CALL,r.call_id,e,t]),r.calls[r.call_id]={success:n,fail:s},r.call_id+=1}}(this))},e.prototype._sendNotification=function(e,t){return this.session._sendMessage([this.id,y.NOTIFY,e,t])},e.prototype._receive=function(e){var t,r,n,s,o,i,c;switch(o=e.shift()){case y.ANSWER:switch(r=e.shift(),c=e.shift()){case 0:return i=e.shift(),this.calls[r].success(i),this.calls[r]=null;case 2:return this.calls[r].fail(e.shift());default:throw Error("unknown rom answer status "+c)}break;case y.NOTIFY:if(s=e.shift(),t=e.shift(),n=this.notification_listeners[s])return n.apply(this,t);throw Error("unhandled notification "+s);default:throw Error("unknown romop")}},e.prototype._on=function(e,t){return this.notification_listeners[e]=t},e.prototype._addROMs=function(e){var t,r,n,s;for(s=[],r=0,n=e.length;n>r;r++)t=e[r],s.push(this[t]=function(e){return function(){var t;return t=Array.prototype.slice.call(arguments,0),this._callRom(e,t)}}(t));return s},e}();var v,E,T,A,L,R={}.hasOwnProperty,b=function(e,t){function r(){this.constructor=e}for(var n in t)R.call(t,n)&&(e[n]=t[n]);return r.prototype=t.prototype,e.prototype=new r,e.__super__=t.prototype,e};v=function(e){function t(e,r){t.__super__.constructor.call(this,e,r,["ping","getPerspective","applyUts"])}return b(t,e),t}(p.RemoteObject),p.remote_classes["com.univedo.connection"]=v,E=function(e){function t(e,r){t.__super__.constructor.call(this,e,r,["query"])}return b(t,e),t}(p.RemoteObject),p.remote_classes["com.univedo.perspective"]=E,T=function(e){function t(e,r){t.__super__.constructor.call(this,e,r,["prepare"])}return b(t,e),t}(p.RemoteObject),p.remote_classes["com.univedo.query"]=T,L=function(e){function t(e,r){t.__super__.constructor.call(this,e,r,["execute","getColumnNames","getColumnTypes"])}return b(t,e),t}(p.RemoteObject),p.remote_classes["com.univedo.statement"]=L,A=function(e){function t(e,n){t.__super__.constructor.call(this,e,n),this._on("setError",this._onerror),this._rows=[],this.rows=new r(function(e){return function(t){return e._on("appendRow",function(e){return this._rows.push(e)}),e._on("setComplete",function(){return t(this._rows)})}}(this)),this.affected_rows=new r(function(e){return function(t){return e._on("setAffectedRecords",function(e){return t(e)})}}(this)),this.last_inserted_id=new r(function(e){return function(t){return e._on("setRecord",function(e){return t(e)})}}(this))}return b(t,e),t.prototype._onerror=function(e){throw Error(e)},t}(p.RemoteObject),p.remote_classes["com.univedo.result"]=A;var I,O=function(e,t){return function(){return e.apply(t,arguments)}};p.Session=I=function(){function e(e,r,n,s,o){this.onopen=null!=n?n:function(){},this.onclose=null!=s?s:function(){},this.onerror=null!=o?o:function(){},this._onerror=O(this._onerror,this),this._receiveRo=O(this._receiveRo,this),this._onmessage=O(this._onmessage,this),this._onclose=O(this._onclose,this),this._socket=new t(e),this._socket.binaryType="arraybuffer",this._socket.onopen=function(e){return function(){return e._urologin=new p.RemoteObject(e,0,["getSession"]),e._urologin.getSession(r).then(function(t){return e._connection=t,e.onopen(e)})}}(this),this._socket.onmessage=this._onmessage,this._socket.onerror=this._onerror,this._socket.onclose=this._onclose,this._remote_objects={}}return e.prototype.close=function(){return this._socket.close()},e.prototype.ping=function(e){return this._connection.ping(e)},e.prototype.getPerspective=function(e){return this._connection.getPerspective(e)},e.prototype.applyUts=function(e){return this._connection.applyUts(e)},e.prototype._onclose=function(){return this.onclose()},e.prototype._onmessage=function(e){var t;return t=new p.Message(new Uint8Array(e.data).buffer,this._receiveRo),this._remote_objects[t.shift()]._receive(t)},e.prototype._receiveRo=function(e){var t,r,n,s;if(t=e[0],n=e[1],r=p.remote_classes[n],!r)throw Error("unknown remote object class "+n);return s=new r(this,t)},e.prototype._onerror=function(e){return console.error("error in websocket"),console.error(e),this.onerror()},e.prototype._sendMessage=function(e){var t,r,n,s;for(t=new p.Message,n=0,s=e.length;s>n;n++)r=e[n],t.send(r);return this._socket.send(t.sendBuffer)},e}(),e.univedo=p}("undefined"!=typeof exports&&null!==exports?exports:this,"undefined"!=typeof WebSocket&&null!==WebSocket?WebSocket:require("ws"),"undefined"!=typeof Promise&&null!==Promise?Promise:require("es6-promise").Promise);