/**
 * univedo v0.1.1 
 * https://github.com/lucas-clemente/univedo-js
 * MIT license, (c) 2013-2014 Univedo
 */
!function(t,e,n){"use strict";var r,s,o,i,c,u,a,h,f,l,p={remote_classes:{}};for(o=[],a={},h=l=0;255>=l;h=++l)o[h]=(h+256).toString(16).substr(1),a[o[h]]=h;f=function(t){var e;return e=new Uint8Array(t),h=0,o[e[h++]]+o[e[h++]]+o[e[h++]]+o[e[h++]]+"-"+o[e[h++]]+o[e[h++]]+"-"+o[e[h++]]+o[e[h++]]+"-"+o[e[h++]]+o[e[h++]]+"-"+o[e[h++]]+o[e[h++]]+o[e[h++]]+o[e[h++]]+o[e[h++]]+o[e[h++]]},s=function(t){var e,n,r,s;for(e=new ArrayBuffer(t.length),n=new Uint8Array(e),h=r=0,s=t.length-1;s>=0?s>=r:r>=s;h=s>=0?++r:--r)n[h]=t.charCodeAt(h);return e},r=function(t){return s(String.fromCharCode.apply(null,t))},i=function(t){var e,n,r,s,o,i,c,u;for(s=0,o=0,c=t.length;c>o;o++)e=t[o],s+=e.byteLength;for(r=new Uint8Array(s),n=0,i=0,u=t.length;u>i;i++)e=t[i],r.set(new Uint8Array(e),n),n+=e.byteLength;return r.buffer},u=function(t){var e,n,r,s;for(n=unescape(encodeURIComponent(t)),e=new Uint8Array(n.length),h=r=0,s=n.length;s>=0?s>r:r>s;h=s>=0?++r:--r)e[h]=n.charCodeAt(h);return e.buffer},c=function(t){var e;return e=String.fromCharCode.apply(null,new Uint8Array(t)),decodeURIComponent(escape(e))};var _,d,g,y;_={UINT:0,NEGINT:1,BYTESTRING:2,TEXTSTRING:3,ARRAY:4,MAP:5,TAG:6,SIMPLE:7},g={DATETIME:0,REMOTEOBJECT:27,UUID:37,RECORD:38},d={FALSE:20,TRUE:21,NULL:22,FLOAT32:26,FLOAT64:27},p.Message=y=function(){function t(t,e){this.recvBuffer=t,this.roCallback=e,this.recvOffset=0,this.sendBuffer=new ArrayBuffer(0)}return t.prototype._getDataView=function(t){var e;return e=new DataView(this.recvBuffer,this.recvOffset,t),this.recvOffset+=t,e},t.prototype._getLen=function(t){var e;switch(e=31&t){case 24:return this._getDataView(1).getUint8(0);case 25:return this._getDataView(2).getUint16(0);case 26:return this._getDataView(4).getUint32(0);case 27:throw Error("int64 not yet supported in javascript!");default:return e}},t.prototype.shift=function(){var t,e,n,r,s,o,i,u,a,h;switch(i=this._getDataView(1).getUint8(0),r=i>>5){case _.UINT:return this._getLen(i);case _.NEGINT:return-this._getLen(i)-1;case _.SIMPLE:switch(31&i){case d.FALSE:return!1;case d.TRUE:return!0;case d.NULL:return null;case d.FLOAT32:return this._getDataView(4).getFloat32(0);case d.FLOAT64:return this._getDataView(8).getFloat64(0);default:throw Error("invalid simple in cbor protocol")}break;case _.BYTESTRING:return n=this._getLen(i),this.recvBuffer.slice(this.recvOffset,this.recvOffset+=n);case _.TEXTSTRING:return n=this._getLen(i),c(this.recvBuffer.slice(this.recvOffset,this.recvOffset+=n));case _.ARRAY:for(n=this._getLen(i),h=[],t=u=0;n>=0?n>u:u>n;t=n>=0?++u:--u)h.push(this.shift());return h;case _.MAP:for(n=this._getLen(i),s={},t=a=0;n>=0?n>a:a>n;t=n>=0?++a:--a)e=this.shift(),s[e]=this.shift();return s;case _.TAG:switch(o=this._getLen(i)){case g.DATETIME:return new Date(this.shift());case g.UUID:return f(this.shift());case g.RECORD:return this.shift();case g.REMOTEOBJECT:return this.roCallback(this.shift());default:throw Error("invalid tag in cbor protocol")}break;default:throw Error("invalid major in cbor protocol")}},t.prototype.send=function(t){return this.sendBuffer=i([this.sendBuffer,this._sendImpl(t)])},t.prototype._sendSimple=function(t){return r([_.SIMPLE<<5|t])},t.prototype._sendTag=function(t){return r([_.TAG<<5|t])},t.prototype._sendLen=function(t,e){var n;switch(n=t<<5,!1){case!(23>=e):return r([n|e]);case!(256>e):return r([24|n,e]);case!(65536>e):return r([25|n,e>>8,255&e]);case!(4294967296>e):return r([26|n,e>>24,e>>16,e>>8,255&e]);default:throw Error("_sendLen() called with non-uint")}},t.prototype._sendImpl=function(t){var e,n,r,s,o,c,a,h,f,l;switch(!1){case"undefined"!=typeof t:throw Error("cannot send undefined");case null!==t:return this._sendSimple(d.NULL);case t!==!0:return this._sendSimple(d.TRUE);case t!==!1:return this._sendSimple(d.FALSE);case"number"!=typeof t:switch(!1){case!(t>=0&&4294967296>t&&t%1===0):return this._sendLen(_.UINT,t);case!(0>t&&t>=-4294967296&&t%1===0):return this._sendLen(_.NEGINT,-t-1);default:return e=new ArrayBuffer(8),new DataView(e).setFloat64(0,t),i([this._sendSimple(d.FLOAT64),e])}break;case"string"!=typeof t:return o=u(t),i([this._sendLen(_.TEXTSTRING,o.byteLength),o]);case"ArrayBuffer"!==t.constructor.name:return i([this._sendLen(_.BYTESTRING,t.byteLength),t]);case"Array"!==t.constructor.name:for(n=[this._sendLen(_.ARRAY,t.length)],a=0,f=t.length;f>a;a++)c=t[a],n.push(this._sendImpl(c));return i(n);case"Object"!==t.constructor.name:for(s=Object.keys(t),n=[this._sendLen(_.MAP,s.length)],h=0,l=s.length;l>h;h++)r=s[h],n.push(this._sendImpl(r)),n.push(this._sendImpl(t[r]));return i(n);case"Date"!==t.constructor.name:return i([this._sendTag(g.DATETIME),this._sendImpl(t.toISOString())]);default:throw Error("unsupported object in cbor protocol")}},t}();var m,w;m={CALL:1,ANSWER:2,NOTIFY:3,DELETE:4},p.RemoteObject=w=function(){function t(t,e,n){this.session=t,this.id=e,null==n&&(n=[]),this.call_id=0,this.calls=[],this.notification_listeners=[],this.session._remote_objects[this.id]=this,this._addROMs(n)}return t.prototype._callRom=function(t,e){return new n(function(n){return function(r,s){return n.session._sendMessage([n.id,m.CALL,n.call_id,t,e]),n.calls[n.call_id]={success:r,fail:s},n.call_id+=1}}(this))},t.prototype._sendNotification=function(t,e){return this.session._sendMessage([this.id,m.NOTIFY,t,e])},t.prototype._receive=function(t){var e,n,r,s,o,i,c;switch(o=t.shift()){case m.ANSWER:switch(n=t.shift(),c=t.shift()){case 0:return i=t.shift(),this.calls[n].success(i),this.calls[n]=null;case 2:return this.calls[n].fail(t.shift());default:throw Error("unknown rom answer status "+c)}break;case m.NOTIFY:if(s=t.shift(),e=t.shift(),r=this.notification_listeners[s])return r.apply(this,e);throw Error("unhandled notification "+s);default:throw Error("unknown romop")}},t.prototype._on=function(t,e){return this.notification_listeners[t]=e},t.prototype._addROMs=function(t){var e,n,r,s;for(s=[],n=0,r=t.length;r>n;n++)e=t[n],s.push(this[e]=function(t){return function(){var e;return e=Array.prototype.slice.call(arguments,0),this._callRom(t,e)}}(e));return s},t}();var v,E,T,A,L,R={}.hasOwnProperty,b=function(t,e){function n(){this.constructor=t}for(var r in e)R.call(e,r)&&(t[r]=e[r]);return n.prototype=e.prototype,t.prototype=new n,t.__super__=e.prototype,t};v=function(t){function e(t,n){e.__super__.constructor.call(this,t,n,["ping","getPerspective","applyUts"])}return b(e,t),e}(p.RemoteObject),p.remote_classes["com.univedo.session"]=v,E=function(t){function e(t,n){e.__super__.constructor.call(this,t,n,["query"])}return b(e,t),e}(p.RemoteObject),p.remote_classes["com.univedo.perspective"]=E,T=function(t){function e(t,n){e.__super__.constructor.call(this,t,n,["prepare"])}return b(e,t),e}(p.RemoteObject),p.remote_classes["com.univedo.query"]=T,L=function(t){function e(t,n){e.__super__.constructor.call(this,t,n),this._on("setColumnNames",function(){})}return b(e,t),e.prototype.execute=function(t){return null==t&&(t={}),this._callRom("execute",[t])},e}(p.RemoteObject),p.remote_classes["com.univedo.statement"]=L,A=function(t){function e(t,r){e.__super__.constructor.call(this,t,r),this._on("setError",this._onerror),this._rows=[],this.rows=new n(function(t){return function(e){return t._on("setTuple",function(t){return this._rows.push(t)}),t._on("setComplete",function(){return e(this._rows)})}}(this)),this.n_affected_rows=new n(function(t){return function(e){return t._on("setNAffectedRecords",function(t){return e(t)})}}(this)),this.last_inserted_id=new n(function(t){return function(e){return t._on("setId",function(t){return e(t)})}}(this))}return b(e,t),e.prototype._onerror=function(t){throw Error(t)},e}(p.RemoteObject),p.remote_classes["com.univedo.result"]=A;var O,I=function(t,e){return function(){return t.apply(e,arguments)}};p.Session=O=function(){function t(t,n,r,s,o){this.onopen=null!=r?r:function(){},this.onclose=null!=s?s:function(){},this.onerror=null!=o?o:function(){},this._onerror=I(this._onerror,this),this._receiveRo=I(this._receiveRo,this),this._onmessage=I(this._onmessage,this),this._onclose=I(this._onclose,this),this._socket=new e(t),this._socket.binaryType="arraybuffer",this._socket.onopen=function(t){return function(){return t._urologin=new p.RemoteObject(t,0,["getSession"]),t._urologin.getSession(n).then(function(e){return t._connection=e,t.onopen(t)})}}(this),this._socket.onmessage=this._onmessage,this._socket.onerror=this._onerror,this._socket.onclose=this._onclose,this._remote_objects={}}return t.prototype.close=function(){return this._socket.close()},t.prototype.ping=function(t){return this._connection.ping(t)},t.prototype.getPerspective=function(t){return this._connection.getPerspective(t)},t.prototype.applyUts=function(t){return this._connection.applyUts(t)},t.prototype._onclose=function(){return this.onclose()},t.prototype._onmessage=function(t){var e;return e=new p.Message(new Uint8Array(t.data).buffer,this._receiveRo),this._remote_objects[e.shift()]._receive(e)},t.prototype._receiveRo=function(t){var e,n,r,s;if(r=t[0],e=t[1],n=p.remote_classes[r],!n)throw Error("unknown remote object class "+r);return s=new n(this,e)},t.prototype._onerror=function(t){return console.error("error in websocket"),console.error(t),this.onerror()},t.prototype._sendMessage=function(t){var e,n,r,s;for(e=new p.Message,r=0,s=t.length;s>r;r++)n=t[r],e.send(n);return this._socket.send(e.sendBuffer)},t}(),t.univedo=p}("undefined"!=typeof exports&&null!==exports?exports:this,"undefined"!=typeof WebSocket&&null!==WebSocket?WebSocket:require("ws"),"undefined"!=typeof Promise&&null!==Promise?Promise:require("es6-promise").Promise);