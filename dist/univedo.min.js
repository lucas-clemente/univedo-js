!function(a){var b;("undefined"==typeof WebSocket||null===WebSocket)&&(a.WebSocket=require("ws")),a.Connection=b=function(){function b(b){this.url=b,this.socket=new a.WebSocket(this.url),this.socket.onopen=this.onopen,this.socket.onmessage=this.onmessage,this.socket.onerror=this.onerror,this.socket.onclose=this.onclose}return b.prototype.close=function(){return this.socket.close()},b.prototype.onopen=function(){return console.log("open")},b.prototype.onmessage=function(){return console.log("message")},b.prototype.onclose=function(){return console.log("close")},b.prototype.onerror=function(){return console.log("error")},b}();var c,d,e,f,g,h,i,j;for(e=[],g={},h=j=0;255>=j;h=++j)e[h]=(h+256).toString(16).substr(1),g[e[h]]=h;i=function(a){return h=0,e[a[h++]]+e[a[h++]]+e[a[h++]]+e[a[h++]]+"-"+e[a[h++]]+e[a[h++]]+"-"+e[a[h++]]+e[a[h++]]+"-"+e[a[h++]]+e[a[h++]]+"-"+e[a[h++]]+e[a[h++]]+e[a[h++]]+e[a[h++]]+e[a[h++]]+e[a[h++]]},d=function(a){var b,c,d,e;for(b=new ArrayBuffer(a.length),c=new Uint8Array(b),h=d=0,e=a.length-1;e>=0?e>=d:d>=e;h=e>=0?++d:--d)c[h]=a.charCodeAt(h);return b},c=function(a){return d(String.fromCharCode.apply(null,a))},f=function(a){var b,c,d,e,f,g,h,i;for(e=0,f=0,h=a.length;h>f;f++)b=a[f],e+=b.byteLength;for(d=new Uint8Array(e),c=0,g=0,i=a.length;i>g;g++)b=a[g],d.set(new Uint8Array(b),c),c+=b.byteLength;return d.buffer};var k,l,m,n;k={UINT:0,NEGINT:1,BYTESTRING:2,TEXTSTRING:3,ARRAY:4,MAP:5,TAG:6,SIMPLE:7},m={DATETIME:0,TIME:1,DECIMAL:4,REMOTEOBJECT:6,UUID:7,RECORD:8},l={FALSE:20,TRUE:21,NULL:22,FLOAT32:26,FLOAT64:27},a.Message=n=function(){function a(a){this.recvBuffer=a,this.recvOffset=0,this.sendBuffer=new ArrayBuffer(0)}return a.prototype.getDataView=function(a){var b;return b=new DataView(this.recvBuffer,this.recvOffset,a),this.recvOffset+=a,b},a.prototype.getLen=function(a){var b;switch(b=31&a){case 24:return this.getDataView(1).getUint8(0);case 25:return this.getDataView(2).getUint16(0);case 26:return this.getDataView(4).getUint32(0);case 27:throw"int64 not yet supported in javascript!";default:return b}},a.prototype.read=function(){var a,b,c,d,e,f,g,h,j,n,o;switch(f=this.getDataView(1).getUint8(0),c=f>>5){case k.UINT:return this.getLen(f);case k.NEGINT:return-this.getLen(f)-1;case k.SIMPLE:switch(31&f){case l.FALSE:return!1;case l.TRUE:return!0;case l.NULL:return null;case l.FLOAT32:return this.getDataView(4).getFloat32(0);case l.FLOAT64:return this.getDataView(8).getFloat64(0);default:throw"invalid simple in cbor protocol"}break;case k.BYTESTRING:return b=this.getLen(f),this.recvBuffer.slice(this.recvOffset,this.recvOffset+=b);case k.TEXTSTRING:return b=this.getLen(f),String.fromCharCode.apply(null,new Uint8Array(this.recvBuffer.slice(this.recvOffset,this.recvOffset+=b)));case k.ARRAY:for(b=this.getLen(f),o=[],a=g=0,j=b-1;j>=0?j>=g:g>=j;a=j>=0?++g:--g)o.push(this.read());return o;case k.MAP:for(b=this.getLen(f),d={},a=h=0,n=b-1;n>=0?n>=h:h>=n;a=n>=0?++h:--h)d[this.read()]=this.read();return d;case k.TAG:switch(e=this.getLen(f)){case m.DATETIME:return new Date(this.read());case m.TIME:return new Date(this.read());case m.UUID:return i(this.read());case m.RECORD:return this.read();default:throw"invalid tag in cbor protocol"}break;default:throw"invalid major in cbor protocol"}},a.prototype.send=function(a){return this.sendBuffer=f([this.sendBuffer,this.sendImpl(a)])},a.prototype.sendSimple=function(a){return c([k.SIMPLE<<5|a])},a.prototype.sendTag=function(a){return c([k.TAG<<5|a])},a.prototype.sendLen=function(a,b){var d;switch(d=a<<5,!1){case!(23>=b):return c([d|b]);case!(256>b):return c([24|d,b]);case!(65536>b):return c([25|d,b>>8,255&b]);case!(4294967296>b):return c([26|d,b>>24,b>>16,b>>8,255&b]);default:throw"sendLen() called with non-uint"}},a.prototype.sendImpl=function(a){var b,c,e,g,h,i,j,n,o;switch(!1){case null!==a:return this.sendSimple(l.NULL);case a!==!0:return this.sendSimple(l.TRUE);case a!==!1:return this.sendSimple(l.FALSE);case"number"!=typeof a:switch(!1){case!(a>=0&&4294967296>a&&a%1===0):return this.sendLen(k.UINT,a);case!(0>a&&a>=-4294967296&&a%1===0):return this.sendLen(k.NEGINT,-a-1);default:return b=new ArrayBuffer(8),new DataView(b).setFloat64(0,a),f([this.sendSimple(l.FLOAT64),b])}break;case"string"!=typeof a:return f([this.sendLen(k.TEXTSTRING,a.length),d(a)]);case"ArrayBuffer"!==a.constructor.name:return f([this.sendLen(k.BYTESTRING,a.byteLength),a]);case"Array"!==a.constructor.name:for(c=[this.sendLen(k.ARRAY,a.length)],i=0,n=a.length;n>i;i++)h=a[i],c.push(this.sendImpl(h));return f(c);case"Object"!==a.constructor.name:for(g=Object.keys(a),c=[this.sendLen(k.MAP,g.length)],j=0,o=g.length;o>j;j++)e=g[j],c.push(this.sendImpl(e)),c.push(this.sendImpl(a[e]));return f(c);case"Date"!==a.constructor.name:return f([this.sendTag(m.DATETIME),this.sendImpl(a.toISOString())]);default:throw"unsupported object in cbor protocol"}},a}();var o,p;o={CALL:1,ANSWER:2,NOTIFY:3,DELETE:4},a.RemoteObject=p=function(){function a(a,b){this.connection=a,this.id=b,this.call_id=0,this.calls=[]}return a.prototype.callRom=function(a,b,c){var d;return this.connection.stream.sendMessage([this.id,o.CALL,this.call_id,a].concat(b)),d={id:this.call_id,onreturn:c},this.calls.push(d),this.call_id+=1},a.prototype.receive=function(a){var b,c,d,e,f;switch(d=a.read()){case o.ANSWER:switch(b=a.read(),f=a.read()){case 0:return e=a.read(),c=this.calls[b].onreturn,this.calls.splice(b,1),c(e)}break;default:throw"unknown romop"}},a}()}("undefined"!=typeof exports&&null!==exports?exports:this);