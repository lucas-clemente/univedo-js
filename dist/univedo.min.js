/**
 * univedo v0.1.0 
 * https://github.com/lucas-clemente/univedo-js
 * MIT license, (c) 2013-2014 Univedo
 */
!function(t){"use strict";var e;e={remote_classes:{}};var r,n,s,o,i,c,u,h,a,f;for(s=[],u={},h=f=0;255>=f;h=++f)s[h]=(h+256).toString(16).substr(1),u[s[h]]=h;a=function(t){return h=0,s[t[h++]]+s[t[h++]]+s[t[h++]]+s[t[h++]]+"-"+s[t[h++]]+s[t[h++]]+"-"+s[t[h++]]+s[t[h++]]+"-"+s[t[h++]]+s[t[h++]]+"-"+s[t[h++]]+s[t[h++]]+s[t[h++]]+s[t[h++]]+s[t[h++]]+s[t[h++]]},n=function(t){var e,r,n,s;for(e=new ArrayBuffer(t.length),r=new Uint8Array(e),h=n=0,s=t.length-1;s>=0?s>=n:n>=s;h=s>=0?++n:--n)r[h]=t.charCodeAt(h);return e},r=function(t){return n(String.fromCharCode.apply(null,t))},o=function(t){var e,r,n,s,o,i,c,u;for(s=0,o=0,c=t.length;c>o;o++)e=t[o],s+=e.byteLength;for(n=new Uint8Array(s),r=0,i=0,u=t.length;u>i;i++)e=t[i],n.set(new Uint8Array(e),r),r+=e.byteLength;return n.buffer},c=function(t){var e,r,n,s;for(r=unescape(encodeURIComponent(t)),e=new Uint8Array(r.length),h=n=0,s=r.length;s>=0?s>n:n>s;h=s>=0?++n:--n)e[h]=r.charCodeAt(h);return e.buffer},i=function(t){var e;return e=String.fromCharCode.apply(null,new Uint8Array(t)),decodeURIComponent(escape(e))};var l,_,p,d;l={UINT:0,NEGINT:1,BYTESTRING:2,TEXTSTRING:3,ARRAY:4,MAP:5,TAG:6,SIMPLE:7},p={DATETIME:0,TIME:1,DECIMAL:4,REMOTEOBJECT:6,UUID:7,RECORD:8},_={FALSE:20,TRUE:21,NULL:22,FLOAT32:26,FLOAT64:27},e.Message=d=function(){function t(t,e){this.recvBuffer=t,this.roCallback=e,this.recvOffset=0,this.sendBuffer=new ArrayBuffer(0)}return t.prototype._getDataView=function(t){var e;return e=new DataView(this.recvBuffer,this.recvOffset,t),this.recvOffset+=t,e},t.prototype._getLen=function(t){var e;switch(e=31&t){case 24:return this._getDataView(1).getUint8(0);case 25:return this._getDataView(2).getUint16(0);case 26:return this._getDataView(4).getUint32(0);case 27:throw Error("int64 not yet supported in javascript!");default:return e}},t.prototype.shift=function(){var t,e,r,n,s,o,c,u,h;switch(o=this._getDataView(1).getUint8(0),r=o>>5){case l.UINT:return this._getLen(o);case l.NEGINT:return-this._getLen(o)-1;case l.SIMPLE:switch(31&o){case _.FALSE:return!1;case _.TRUE:return!0;case _.NULL:return null;case _.FLOAT32:return this._getDataView(4).getFloat32(0);case _.FLOAT64:return this._getDataView(8).getFloat64(0);default:throw Error("invalid simple in cbor protocol")}break;case l.BYTESTRING:return e=this._getLen(o),this.recvBuffer.slice(this.recvOffset,this.recvOffset+=e);case l.TEXTSTRING:return e=this._getLen(o),i(this.recvBuffer.slice(this.recvOffset,this.recvOffset+=e));case l.ARRAY:for(e=this._getLen(o),h=[],t=c=0;e>=0?e>c:c>e;t=e>=0?++c:--c)h.push(this.shift());return h;case l.MAP:for(e=this._getLen(o),n={},t=u=0;e>=0?e>u:u>e;t=e>=0?++u:--u)n[this.shift()]=this.shift();return n;case l.TAG:switch(s=this._getLen(o)){case p.DATETIME:return new Date(this.shift());case p.TIME:return new Date(this.shift());case p.UUID:return a(this.shift());case p.RECORD:return this.shift();case p.REMOTEOBJECT:return this.roCallback(this.shift());default:throw Error("invalid tag in cbor protocol")}break;default:throw Error("invalid major in cbor protocol")}},t.prototype.send=function(t){return this.sendBuffer=o([this.sendBuffer,this._sendImpl(t)])},t.prototype._sendSimple=function(t){return r([l.SIMPLE<<5|t])},t.prototype._sendTag=function(t){return r([l.TAG<<5|t])},t.prototype._sendLen=function(t,e){var n;switch(n=t<<5,!1){case!(23>=e):return r([n|e]);case!(256>e):return r([24|n,e]);case!(65536>e):return r([25|n,e>>8,255&e]);case!(4294967296>e):return r([26|n,e>>24,e>>16,e>>8,255&e]);default:throw Error("_sendLen() called with non-uint")}},t.prototype._sendImpl=function(t){var e,r,n,s,i,u,h,a,f,d;switch(!1){case null!==t:return this._sendSimple(_.NULL);case t!==!0:return this._sendSimple(_.TRUE);case t!==!1:return this._sendSimple(_.FALSE);case"number"!=typeof t:switch(!1){case!(t>=0&&4294967296>t&&t%1===0):return this._sendLen(l.UINT,t);case!(0>t&&t>=-4294967296&&t%1===0):return this._sendLen(l.NEGINT,-t-1);default:return e=new ArrayBuffer(8),new DataView(e).setFloat64(0,t),o([this._sendSimple(_.FLOAT64),e])}break;case"string"!=typeof t:return i=c(t),o([this._sendLen(l.TEXTSTRING,i.byteLength),i]);case"ArrayBuffer"!==t.constructor.name:return o([this._sendLen(l.BYTESTRING,t.byteLength),t]);case"Array"!==t.constructor.name:for(r=[this._sendLen(l.ARRAY,t.length)],h=0,f=t.length;f>h;h++)u=t[h],r.push(this._sendImpl(u));return o(r);case"Object"!==t.constructor.name:for(s=Object.keys(t),r=[this._sendLen(l.MAP,s.length)],a=0,d=s.length;d>a;a++)n=s[a],r.push(this._sendImpl(n)),r.push(this._sendImpl(t[n]));return o(r);case"Date"!==t.constructor.name:return o([this._sendTag(p.DATETIME),this._sendImpl(t.toISOString())]);default:throw Error("unsupported object in cbor protocol")}},t}();var g,m;g={CALL:1,ANSWER:2,NOTIFY:3,DELETE:4},e.RemoteObject=m=function(){function t(t,e,r){this.session=t,this.id=e,null==r&&(r=[]),this.call_id=0,this.calls=[],this.notification_listeners=[],this.session._remote_objects[this.id]=this,this._addROMs(r)}return t.prototype._callRom=function(t,e,r){return this.session._sendMessage([this.id,g.CALL,this.call_id,t,e]),this.calls[this.call_id]=r,this.call_id+=1},t.prototype._sendNotification=function(t,e){return this.session._sendMessage([this.id,g.NOTIFY,t,e])},t.prototype._receive=function(t){var e,r,n,s,o,i,c;switch(o=t.shift()){case g.ANSWER:switch(r=t.shift(),c=t.shift()){case 0:return i=t.shift(),this.calls[r](i),this.calls[r]=null;case 2:throw Error(t.shift());default:throw Error("unknown rom answer status "+c)}break;case g.NOTIFY:if(s=t.shift(),e=t.shift(),n=this.notification_listeners[s])return n.apply(this,e);throw Error("unhandled notification "+s);default:throw Error("unknown romop")}},t.prototype._on=function(t,e){return this.notification_listeners[t]=e},t.prototype._addROMs=function(t){var e,r,n,s;for(s=[],r=0,n=t.length;n>r;r++)e=t[r],s.push(this[e]=function(t){return function(){var e,r;return e=Array.prototype.slice.call(arguments,0),r=e.pop(),this._callRom(t,e,r)}}(e));return s},t}();var w,y,v,E,T,R={}.hasOwnProperty,A=function(t,e){function r(){this.constructor=t}for(var n in e)R.call(e,n)&&(t[n]=e[n]);return r.prototype=e.prototype,t.prototype=new r,t.__super__=e.prototype,t};w=function(t){function e(t,r){e.__super__.constructor.call(this,t,r,["ping","getPerspective"])}return A(e,t),e}(e.RemoteObject),e.remote_classes["com.univedo.connection"]=w,y=function(t){function e(t,r){e.__super__.constructor.call(this,t,r,["query"])}return A(e,t),e}(e.RemoteObject),e.remote_classes["com.univedo.perspective"]=y,v=function(t){function e(t,r){e.__super__.constructor.call(this,t,r,["prepare"])}return A(e,t),e}(e.RemoteObject),e.remote_classes["com.univedo.query"]=v,T=function(t){function e(t,r){e.__super__.constructor.call(this,t,r)}return A(e,t),e.prototype.execute=function(t,e){return e||(e=t,t={}),this._callRom("execute",[t],function(t){return t._oncomplete=function(){return e(t)}})},e}(e.RemoteObject),e.remote_classes["com.univedo.statement"]=T,E=function(t){function e(t,r){e.__super__.constructor.call(this,t,r),this._on("setError",this._onerror),this.rows=[],this._on("appendRow",function(t){return this.rows.push(t)}),this._on("setComplete",function(){return this._oncomplete()}),this.affected_rows=null,this.num_affected_rows=null,this._on("setAffectedRecords",function(t){return this.affected_rows=t,this.num_affected_rows=this.affected_rows.length}),this.last_inserted_id=null,this._on("setRecord",function(t){return this.last_inserted_id=t})}return A(e,t),e.prototype._onerror=function(t){throw Error(t)},e.prototype._oncomplete=function(){},e}(e.RemoteObject),e.remote_classes["com.univedo.result"]=E;var L,b,I=function(t,e){return function(){return t.apply(e,arguments)}};b="undefined"!=typeof WebSocket&&null!==WebSocket?WebSocket:require("ws"),e.Session=L=function(){function t(t,r,n,s,o){this.onopen=null!=n?n:function(){},this.onclose=null!=s?s:function(){},this.onerror=null!=o?o:function(){},this._onerror=I(this._onerror,this),this._receiveRo=I(this._receiveRo,this),this._onmessage=I(this._onmessage,this),this._onclose=I(this._onclose,this),this._socket=new b(t),this._socket.onopen=function(t){return function(){return t._urologin=new e.RemoteObject(t,0,["getSession"]),t._urologin.getSession(r,function(e){return t._connection=e,t.onopen()})}}(this),this._socket.onmessage=this._onmessage,this._socket.onerror=this._onerror,this._socket.onclose=this._onclose,this._remote_objects={}}return t.prototype.close=function(){return this._socket.close()},t.prototype.ping=function(t,e){return this._connection.ping(t,e)},t.prototype.getPerspective=function(t,e){return this._connection.getPerspective(t,e)},t.prototype._onclose=function(){return this.onclose()},t.prototype._onmessage=function(t){var r;return r=new e.Message(new Uint8Array(t.data).buffer,this._receiveRo),this._remote_objects[r.shift()]._receive(r)},t.prototype._receiveRo=function(t){var r,n,s,o;if(r=t[0],s=t[1],n=e.remote_classes[s],!n)throw Error("unknown remote object class "+s);return o=new n(this,r)},t.prototype._onerror=function(t){return console.error("error "+t),this.onerror()},t.prototype._sendMessage=function(t){var r,n,s,o;for(r=new e.Message,s=0,o=t.length;o>s;s++)n=t[s],r.send(n);return this._socket.send(r.sendBuffer)},t}(),t.univedo=e}("undefined"!=typeof exports&&null!==exports?exports:this);