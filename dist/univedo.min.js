/**
 * univedo - Univedo client for javascript
 * @version v0.1.0
 * @link https://github.com/lucas-clemente/univedo-js
 * @license MIT
 */
define(["ws"],function(e){var t,r={};r.Connection=t=function(){function t(t){this.url=t,this.socket=new e(this.url),this.socket.onopen=this.onopen,this.socket.onmessage=this.onmessage,this.socket.onerror=this.onerror,this.socket.onclose=this.onclose}return t.prototype.close=function(){return this.socket.close()},t.prototype.onopen=function(){return console.log("open")},t.prototype.onmessage=function(){return console.log("message")},t.prototype.onclose=function(){return console.log("close")},t.prototype.onerror=function(){return console.log("error")},t}();var n,s,o,i,a,c,u,h;for(o=[],a={},c=h=0;255>=h;c=++h)o[c]=(c+256).toString(16).substr(1),a[o[c]]=c;u=function(e){return c=0,o[e[c++]]+o[e[c++]]+o[e[c++]]+o[e[c++]]+"-"+o[e[c++]]+o[e[c++]]+"-"+o[e[c++]]+o[e[c++]]+"-"+o[e[c++]]+o[e[c++]]+"-"+o[e[c++]]+o[e[c++]]+o[e[c++]]+o[e[c++]]+o[e[c++]]+o[e[c++]]},s=function(e){var t,r,n,s;for(t=new ArrayBuffer(e.length),r=new Uint8Array(t),c=n=0,s=e.length-1;s>=0?s>=n:n>=s;c=s>=0?++n:--n)r[c]=e.charCodeAt(c);return t},n=function(e){return s(String.fromCharCode.apply(null,e))},i=function(e){var t,r,n,s,o,i,a,c;for(s=0,o=0,a=e.length;a>o;o++)t=e[o],s+=t.byteLength;for(n=new Uint8Array(s),r=0,i=0,c=e.length;c>i;i++)t=e[i],n.set(new Uint8Array(t),r),r+=t.byteLength;return n.buffer};var l,f,p,d;l={UINT:0,NEGINT:1,BYTESTRING:2,TEXTSTRING:3,ARRAY:4,MAP:5,TAG:6,SIMPLE:7},p={DATETIME:0,TIME:1,DECIMAL:4,REMOTEOBJECT:6,UUID:7,RECORD:8},f={FALSE:20,TRUE:21,NULL:22,FLOAT32:26,FLOAT64:27},r.Message=d=function(){function e(e){this.recvBuffer=e,this.recvOffset=0,this.sendBuffer=new ArrayBuffer(0)}return e.prototype.getDataView=function(e){var t;return t=new DataView(this.recvBuffer,this.recvOffset,e),this.recvOffset+=e,t},e.prototype.getLen=function(e){var t;switch(t=31&e){case 24:return this.getDataView(1).getUint8(0);case 25:return this.getDataView(2).getUint16(0);case 26:return this.getDataView(4).getUint32(0);case 27:throw Error("int64 not yet supported in javascript!");default:return t}},e.prototype.read=function(){var e,t,r,n,s,o,i,a,c,h,d,g;switch(i=this.getDataView(1).getUint8(0),n=i>>5){case l.UINT:return this.getLen(i);case l.NEGINT:return-this.getLen(i)-1;case l.SIMPLE:switch(31&i){case f.FALSE:return!1;case f.TRUE:return!0;case f.NULL:return null;case f.FLOAT32:return this.getDataView(4).getFloat32(0);case f.FLOAT64:return this.getDataView(8).getFloat64(0);default:throw Error("invalid simple in cbor protocol")}break;case l.BYTESTRING:return r=this.getLen(i),this.recvBuffer.slice(this.recvOffset,this.recvOffset+=r);case l.TEXTSTRING:return r=this.getLen(i),e=new Uint8Array(this.recvBuffer.slice(this.recvOffset,this.recvOffset+=r)),String.fromCharCode.apply(null,e);case l.ARRAY:for(r=this.getLen(i),g=[],t=a=0,h=r-1;h>=0?h>=a:a>=h;t=h>=0?++a:--a)g.push(this.read());return g;case l.MAP:for(r=this.getLen(i),s={},t=c=0,d=r-1;d>=0?d>=c:c>=d;t=d>=0?++c:--c)s[this.read()]=this.read();return s;case l.TAG:switch(o=this.getLen(i)){case p.DATETIME:return new Date(this.read());case p.TIME:return new Date(this.read());case p.UUID:return u(this.read());case p.RECORD:return this.read();default:throw Error("invalid tag in cbor protocol")}break;default:throw Error("invalid major in cbor protocol")}},e.prototype.send=function(e){return this.sendBuffer=i([this.sendBuffer,this.sendImpl(e)])},e.prototype.sendSimple=function(e){return n([l.SIMPLE<<5|e])},e.prototype.sendTag=function(e){return n([l.TAG<<5|e])},e.prototype.sendLen=function(e,t){var r;switch(r=e<<5,!1){case!(23>=t):return n([r|t]);case!(256>t):return n([24|r,t]);case!(65536>t):return n([25|r,t>>8,255&t]);case!(4294967296>t):return n([26|r,t>>24,t>>16,t>>8,255&t]);default:throw Error("sendLen() called with non-uint")}},e.prototype.sendImpl=function(e){var t,r,n,o,a,c,u,h,d;switch(!1){case null!==e:return this.sendSimple(f.NULL);case e!==!0:return this.sendSimple(f.TRUE);case e!==!1:return this.sendSimple(f.FALSE);case"number"!=typeof e:switch(!1){case!(e>=0&&4294967296>e&&e%1===0):return this.sendLen(l.UINT,e);case!(0>e&&e>=-4294967296&&e%1===0):return this.sendLen(l.NEGINT,-e-1);default:return t=new ArrayBuffer(8),new DataView(t).setFloat64(0,e),i([this.sendSimple(f.FLOAT64),t])}break;case"string"!=typeof e:return i([this.sendLen(l.TEXTSTRING,e.length),s(e)]);case"ArrayBuffer"!==e.constructor.name:return i([this.sendLen(l.BYTESTRING,e.byteLength),e]);case"Array"!==e.constructor.name:for(r=[this.sendLen(l.ARRAY,e.length)],c=0,h=e.length;h>c;c++)a=e[c],r.push(this.sendImpl(a));return i(r);case"Object"!==e.constructor.name:for(o=Object.keys(e),r=[this.sendLen(l.MAP,o.length)],u=0,d=o.length;d>u;u++)n=o[u],r.push(this.sendImpl(n)),r.push(this.sendImpl(e[n]));return i(r);case"Date"!==e.constructor.name:return i([this.sendTag(p.DATETIME),this.sendImpl(e.toISOString())]);default:throw Error("unsupported object in cbor protocol")}},e}();var g,T;return g={CALL:1,ANSWER:2,NOTIFY:3,DELETE:4},r.RemoteObject=T=function(){function e(e,t){this.connection=e,this.id=t,this.call_id=0,this.calls=[]}return e.prototype.callRom=function(e,t,r){var n;return this.connection.stream.sendMessage([this.id,g.CALL,this.call_id,e].concat(t)),n={id:this.call_id,onreturn:r},this.calls.push(n),this.call_id+=1},e.prototype.receive=function(e){var t,r,n,s,o;switch(n=e.read()){case g.ANSWER:switch(t=e.read(),o=e.read()){case 0:return s=e.read(),r=this.calls[t].onreturn,this.calls.splice(t,1),r(s)}break;default:throw Error("unknown romop")}},e}(),r});