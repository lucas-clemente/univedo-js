/**
 * univedo - Univedo client for javascript
 * @version v0.1.0
 * @link https://github.com/lucas-clemente/univedo-js
 * @license MIT
 */
define(["ws"],function(t){var e,n={},r=function(t,e){return function(){return t.apply(e,arguments)}};n.Connection=e=function(){function e(e){this.url=e,this._onclose=r(this._onclose,this),this._onopen=r(this._onopen,this),this.socket=new t(this.url),this.socket.onopen=this._onopen,this.socket.onmessage=this._onmessage,this.socket.onerror=this._onerror,this.socket.onclose=this._onclose}return e.prototype.close=function(){return this.socket.close()},e.prototype._onopen=function(){return this.onopen()},e.prototype._onclose=function(){return this.onclose()},e.prototype._onmessage=function(){return console.log("message")},e.prototype._onerror=function(){return console.log("error")},e.prototype.onopen=function(){},e.prototype.onclose=function(){},e}();var s,i,o,c,a,h,u,f;for(o=[],a={},h=f=0;255>=f;h=++f)o[h]=(h+256).toString(16).substr(1),a[o[h]]=h;u=function(t){return h=0,o[t[h++]]+o[t[h++]]+o[t[h++]]+o[t[h++]]+"-"+o[t[h++]]+o[t[h++]]+"-"+o[t[h++]]+o[t[h++]]+"-"+o[t[h++]]+o[t[h++]]+"-"+o[t[h++]]+o[t[h++]]+o[t[h++]]+o[t[h++]]+o[t[h++]]+o[t[h++]]},i=function(t){var e,n,r,s;for(e=new ArrayBuffer(t.length),n=new Uint8Array(e),h=r=0,s=t.length-1;s>=0?s>=r:r>=s;h=s>=0?++r:--r)n[h]=t.charCodeAt(h);return e},s=function(t){return i(String.fromCharCode.apply(null,t))},c=function(t){var e,n,r,s,i,o,c,a;for(s=0,i=0,c=t.length;c>i;i++)e=t[i],s+=e.byteLength;for(r=new Uint8Array(s),n=0,o=0,a=t.length;a>o;o++)e=t[o],r.set(new Uint8Array(e),n),n+=e.byteLength;return r.buffer};var l,p,_,d;l={UINT:0,NEGINT:1,BYTESTRING:2,TEXTSTRING:3,ARRAY:4,MAP:5,TAG:6,SIMPLE:7},_={DATETIME:0,TIME:1,DECIMAL:4,REMOTEOBJECT:6,UUID:7,RECORD:8},p={FALSE:20,TRUE:21,NULL:22,FLOAT32:26,FLOAT64:27},n.Message=d=function(){function t(t){this.recvBuffer=t,this.recvOffset=0,this.sendBuffer=new ArrayBuffer(0)}return t.prototype._getDataView=function(t){var e;return e=new DataView(this.recvBuffer,this.recvOffset,t),this.recvOffset+=t,e},t.prototype._getLen=function(t){var e;switch(e=31&t){case 24:return this._getDataView(1).getUint8(0);case 25:return this._getDataView(2).getUint16(0);case 26:return this._getDataView(4).getUint32(0);case 27:throw Error("int64 not yet supported in javascript!");default:return e}},t.prototype.shift=function(){var t,e,n,r,s,i,o,c,a,h,f,d;switch(o=this._getDataView(1).getUint8(0),r=o>>5){case l.UINT:return this._getLen(o);case l.NEGINT:return-this._getLen(o)-1;case l.SIMPLE:switch(31&o){case p.FALSE:return!1;case p.TRUE:return!0;case p.NULL:return null;case p.FLOAT32:return this._getDataView(4).getFloat32(0);case p.FLOAT64:return this._getDataView(8).getFloat64(0);default:throw Error("invalid simple in cbor protocol")}break;case l.BYTESTRING:return n=this._getLen(o),this.recvBuffer.slice(this.recvOffset,this.recvOffset+=n);case l.TEXTSTRING:return n=this._getLen(o),t=new Uint8Array(this.recvBuffer.slice(this.recvOffset,this.recvOffset+=n)),String.fromCharCode.apply(null,t);case l.ARRAY:for(n=this._getLen(o),d=[],e=c=0,h=n-1;h>=0?h>=c:c>=h;e=h>=0?++c:--c)d.push(this.shift());return d;case l.MAP:for(n=this._getLen(o),s={},e=a=0,f=n-1;f>=0?f>=a:a>=f;e=f>=0?++a:--a)s[this.shift()]=this.shift();return s;case l.TAG:switch(i=this._getLen(o)){case _.DATETIME:return new Date(this.shift());case _.TIME:return new Date(this.shift());case _.UUID:return u(this.shift());case _.RECORD:return this.shift();default:throw Error("invalid tag in cbor protocol")}break;default:throw Error("invalid major in cbor protocol")}},t.prototype.send=function(t){return this.sendBuffer=c([this.sendBuffer,this._sendImpl(t)])},t.prototype._sendSimple=function(t){return s([l.SIMPLE<<5|t])},t.prototype._sendTag=function(t){return s([l.TAG<<5|t])},t.prototype._sendLen=function(t,e){var n;switch(n=t<<5,!1){case!(23>=e):return s([n|e]);case!(256>e):return s([24|n,e]);case!(65536>e):return s([25|n,e>>8,255&e]);case!(4294967296>e):return s([26|n,e>>24,e>>16,e>>8,255&e]);default:throw Error("_sendLen() called with non-uint")}},t.prototype._sendImpl=function(t){var e,n,r,s,o,a,h,u,f;switch(!1){case null!==t:return this._sendSimple(p.NULL);case t!==!0:return this._sendSimple(p.TRUE);case t!==!1:return this._sendSimple(p.FALSE);case"number"!=typeof t:switch(!1){case!(t>=0&&4294967296>t&&t%1===0):return this._sendLen(l.UINT,t);case!(0>t&&t>=-4294967296&&t%1===0):return this._sendLen(l.NEGINT,-t-1);default:return e=new ArrayBuffer(8),new DataView(e).setFloat64(0,t),c([this._sendSimple(p.FLOAT64),e])}break;case"string"!=typeof t:return c([this._sendLen(l.TEXTSTRING,t.length),i(t)]);case"ArrayBuffer"!==t.constructor.name:return c([this._sendLen(l.BYTESTRING,t.byteLength),t]);case"Array"!==t.constructor.name:for(n=[this._sendLen(l.ARRAY,t.length)],a=0,u=t.length;u>a;a++)o=t[a],n.push(this._sendImpl(o));return c(n);case"Object"!==t.constructor.name:for(s=Object.keys(t),n=[this._sendLen(l.MAP,s.length)],h=0,f=s.length;f>h;h++)r=s[h],n.push(this._sendImpl(r)),n.push(this._sendImpl(t[r]));return c(n);case"Date"!==t.constructor.name:return c([this._sendTag(_.DATETIME),this._sendImpl(t.toISOString())]);default:throw Error("unsupported object in cbor protocol")}},t}();var g,T;return g={CALL:1,ANSWER:2,NOTIFY:3,DELETE:4},n.RemoteObject=T=function(){function t(t,e){this.connection=t,this.id=e,this.call_id=0,this.calls=[],this.notification_listeners=[]}return t.prototype._callRom=function(t,e,n){var r;return this.connection.stream.sendMessage([this.id,g.CALL,this.call_id,t,e]),r={id:this.call_id,onreturn:n},this.calls.push(r),this.call_id+=1},t.prototype._sendNotification=function(t,e){return this.connection.stream.sendMessage([this.id,g.NOTIFY,t,e])},t.prototype._receive=function(t){var e,n,r,s,i,o,c,a;switch(o=t.shift()){case g.ANSWER:switch(r=t.shift(),a=t.shift()){case 0:return c=t.shift(),n=this.calls.splice(r,1)[0],n.onreturn(c)}break;case g.NOTIFY:if(i=t.shift(),e=t.shift(),s=this.notification_listeners[i])return s.apply(this,e);throw Error("unhandled notification "+i);default:throw Error("unknown romop")}},t.prototype.on=function(t,e){return this.notification_listeners[t]=e},t}(),n});