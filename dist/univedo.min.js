/**
 * univedo v0.1.0 
 * https://github.com/lucas-clemente/univedo-js
 * MIT license, (c) 2013-2014 Univedo
 */
define(["ws"],function(t){var e,r,n,s,o,i,c,h,a={};for(n=[],o={},i=h=0;255>=h;i=++h)n[i]=(i+256).toString(16).substr(1),o[n[i]]=i;c=function(t){return i=0,n[t[i++]]+n[t[i++]]+n[t[i++]]+n[t[i++]]+"-"+n[t[i++]]+n[t[i++]]+"-"+n[t[i++]]+n[t[i++]]+"-"+n[t[i++]]+n[t[i++]]+"-"+n[t[i++]]+n[t[i++]]+n[t[i++]]+n[t[i++]]+n[t[i++]]+n[t[i++]]},r=function(t){var e,r,n,s;for(e=new ArrayBuffer(t.length),r=new Uint8Array(e),i=n=0,s=t.length-1;s>=0?s>=n:n>=s;i=s>=0?++n:--n)r[i]=t.charCodeAt(i);return e},e=function(t){return r(String.fromCharCode.apply(null,t))},s=function(t){var e,r,n,s,o,i,c,h;for(s=0,o=0,c=t.length;c>o;o++)e=t[o],s+=e.byteLength;for(n=new Uint8Array(s),r=0,i=0,h=t.length;h>i;i++)e=t[i],n.set(new Uint8Array(e),r),r+=e.byteLength;return n.buffer};var u,f,l,_;u={UINT:0,NEGINT:1,BYTESTRING:2,TEXTSTRING:3,ARRAY:4,MAP:5,TAG:6,SIMPLE:7},l={DATETIME:0,TIME:1,DECIMAL:4,REMOTEOBJECT:6,UUID:7,RECORD:8},f={FALSE:20,TRUE:21,NULL:22,FLOAT32:26,FLOAT64:27},a.Message=_=function(){function t(t,e){this.recvBuffer=t,this.roCallback=e,this.recvOffset=0,this.sendBuffer=new ArrayBuffer(0)}return t.prototype._getDataView=function(t){var e;return e=new DataView(this.recvBuffer,this.recvOffset,t),this.recvOffset+=t,e},t.prototype._getLen=function(t){var e;switch(e=31&t){case 24:return this._getDataView(1).getUint8(0);case 25:return this._getDataView(2).getUint16(0);case 26:return this._getDataView(4).getUint32(0);case 27:throw Error("int64 not yet supported in javascript!");default:return e}},t.prototype.shift=function(){var t,e,r,n,s,o,i,h,a,_,p,g;switch(i=this._getDataView(1).getUint8(0),n=i>>5){case u.UINT:return this._getLen(i);case u.NEGINT:return-this._getLen(i)-1;case u.SIMPLE:switch(31&i){case f.FALSE:return!1;case f.TRUE:return!0;case f.NULL:return null;case f.FLOAT32:return this._getDataView(4).getFloat32(0);case f.FLOAT64:return this._getDataView(8).getFloat64(0);default:throw Error("invalid simple in cbor protocol")}break;case u.BYTESTRING:return r=this._getLen(i),this.recvBuffer.slice(this.recvOffset,this.recvOffset+=r);case u.TEXTSTRING:return r=this._getLen(i),t=new Uint8Array(this.recvBuffer.slice(this.recvOffset,this.recvOffset+=r)),String.fromCharCode.apply(null,t);case u.ARRAY:for(r=this._getLen(i),g=[],e=h=0,_=r-1;_>=0?_>=h:h>=_;e=_>=0?++h:--h)g.push(this.shift());return g;case u.MAP:for(r=this._getLen(i),s={},e=a=0,p=r-1;p>=0?p>=a:a>=p;e=p>=0?++a:--a)s[this.shift()]=this.shift();return s;case u.TAG:switch(o=this._getLen(i)){case l.DATETIME:return new Date(this.shift());case l.TIME:return new Date(this.shift());case l.UUID:return c(this.shift());case l.RECORD:return this.shift();case l.REMOTEOBJECT:return this.roCallback(this.shift());default:throw Error("invalid tag in cbor protocol")}break;default:throw Error("invalid major in cbor protocol")}},t.prototype.send=function(t){return this.sendBuffer=s([this.sendBuffer,this._sendImpl(t)])},t.prototype._sendSimple=function(t){return e([u.SIMPLE<<5|t])},t.prototype._sendTag=function(t){return e([u.TAG<<5|t])},t.prototype._sendLen=function(t,r){var n;switch(n=t<<5,!1){case!(23>=r):return e([n|r]);case!(256>r):return e([24|n,r]);case!(65536>r):return e([25|n,r>>8,255&r]);case!(4294967296>r):return e([26|n,r>>24,r>>16,r>>8,255&r]);default:throw Error("_sendLen() called with non-uint")}},t.prototype._sendImpl=function(t){var e,n,o,i,c,h,a,_,p;switch(!1){case null!==t:return this._sendSimple(f.NULL);case t!==!0:return this._sendSimple(f.TRUE);case t!==!1:return this._sendSimple(f.FALSE);case"number"!=typeof t:switch(!1){case!(t>=0&&4294967296>t&&t%1===0):return this._sendLen(u.UINT,t);case!(0>t&&t>=-4294967296&&t%1===0):return this._sendLen(u.NEGINT,-t-1);default:return e=new ArrayBuffer(8),new DataView(e).setFloat64(0,t),s([this._sendSimple(f.FLOAT64),e])}break;case"string"!=typeof t:return s([this._sendLen(u.TEXTSTRING,t.length),r(t)]);case"ArrayBuffer"!==t.constructor.name:return s([this._sendLen(u.BYTESTRING,t.byteLength),t]);case"Array"!==t.constructor.name:for(n=[this._sendLen(u.ARRAY,t.length)],h=0,_=t.length;_>h;h++)c=t[h],n.push(this._sendImpl(c));return s(n);case"Object"!==t.constructor.name:for(i=Object.keys(t),n=[this._sendLen(u.MAP,i.length)],a=0,p=i.length;p>a;a++)o=i[a],n.push(this._sendImpl(o)),n.push(this._sendImpl(t[o]));return s(n);case"Date"!==t.constructor.name:return s([this._sendTag(l.DATETIME),this._sendImpl(t.toISOString())]);default:throw Error("unsupported object in cbor protocol")}},t}();var p,g;p={CALL:1,ANSWER:2,NOTIFY:3,DELETE:4},a.RemoteObject=g=function(){function t(t,e){this.session=t,this.id=e,this.call_id=0,this.calls=[],this.notification_listeners=[],this.session._remote_objects[this.id]=this}return t.prototype._callRom=function(t,e,r){var n;return this.session._sendMessage([this.id,p.CALL,this.call_id,t,e]),n={id:this.call_id,onreturn:r},this.calls.push(n),this.call_id+=1},t.prototype._sendNotification=function(t,e){return this.session._sendMessage([this.id,p.NOTIFY,t,e])},t.prototype._receive=function(t){var e,r,n,s,o,i,c,h;switch(i=t.shift()){case p.ANSWER:switch(n=t.shift(),h=t.shift()){case 0:return c=t.shift(),r=this.calls.splice(n,1)[0],r.onreturn(c);case 2:throw Error(t.shift());default:throw Error("unknown rom answer status "+h)}break;case p.NOTIFY:if(o=t.shift(),e=t.shift(),s=this.notification_listeners[o])return s.apply(this,e);throw Error("unhandled notification "+o);default:throw Error("unknown romop")}},t.prototype.on=function(t,e){return this.notification_listeners[t]=e},t}();var d,w=function(t,e){return function(){return t.apply(e,arguments)}};return a.Session=d=function(){function e(e,r,n,s,o){this.onopen=null!=n?n:function(){},this.onclose=null!=s?s:function(){},this.onerror=null!=o?o:function(){},this._onerror=w(this._onerror,this),this._receiveRo=w(this._receiveRo,this),this._onmessage=w(this._onmessage,this),this._onclose=w(this._onclose,this),this._socket=new t(e),this._socket.onopen=function(t){return function(){return console.log("onopen"),t.urologin=new a.RemoteObject(t,0),t.urologin._callRom("getSession",[r],function(e){return t.session=e,t.onopen()})}}(this),this._socket.onmessage=this._onmessage,this._socket.onerror=this._onerror,this._socket.onclose=this._onclose,this._remote_objects={}}return e.prototype.close=function(){return this._socket.close()},e.prototype.ping=function(t,e){return this.session._callRom("ping",[t],e)},e.prototype._onclose=function(){return console.log("socket close"),this.onclose()},e.prototype._onmessage=function(t){var e;return console.log("onmessage"),e=new a.Message(new Uint8Array(t.data).buffer,this._receiveRo),this._remote_objects[e.shift()]._receive(e)},e.prototype._receiveRo=function(t){var e,r;return e=t[0],r=new a.RemoteObject(this,e),this._remote_objects[e]=r},e.prototype._onerror=function(t){return console.log("error "+t),this.onerror()},e.prototype._sendMessage=function(t){var e,r,n,s;for(console.log(t),e=new a.Message,n=0,s=t.length;s>n;n++)r=t[n],e.send(r);return this._socket.send(e.sendBuffer)},e}(),a});